<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SEPA-XML Generator (with BLZ -> BIC Lookup, pain.008.001.08)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, select, button {
      margin-top: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
      max-width: 400px;
    }
    .error {
      color: red;
      font-size: 0.9rem;
    }
    .success {
      color: green;
      font-size: 0.9rem;
    }
    hr {
      margin: 2rem 0;
    }
    .hidden {
      display: none;
    }
    table {
      margin-top: 1rem;
      border-collapse: collapse;
      width: 100%;
      max-width: 800px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>SEPA-XML Generator (pain.008.001.08) with BLZ-&gt;BIC Lookup</h1>
  <p>
    This tool reads a .csv file and generates a SEPA XML.
    Additionally, for German IBANs, the BIC can be automatically determined from the BLZ.
    <br>
  </p>
  
  <!-- Form for creditor data -->
  <h2>Creditor Data</h2>
  <form id="creditorForm">
    <label for="creditorName">Creditor Name</label>
    <input type="text" id="creditorName" required />

    <label for="creditorIBAN">Creditor IBAN</label>
    <input type="text" id="creditorIBAN" required />

    <label for="creditorBIC">Creditor BIC (will be automatically detected if possible)</label>
    <input type="text" id="creditorBIC" required />

    <label for="creditorId">Creditor Identifier</label>
    <input type="text" id="creditorId" required />

    <label for="paymentInfoId">Payment Info ID (e.g., RE-2023-001)</label>
    <input type="text" id="paymentInfoId" required />

    <label for="executionDate">Execution Date (YYYY-MM-DD)</label>
    <input type="date" id="executionDate" required />

    <label for="currency">Currency</label>
    <input type="text" id="currency" value="EUR" required />

    <!-- NEW: Dropdown for Sequence Type -->
    <label for="sequenceType">Sequence Type (e.g., FRST, RCUR, OOFF, FNAL)</label>
    <select id="sequenceType">
      <option value="FRST">First Direct Debit (FRST)</option>
      <option value="RCUR" selected>Recurring Direct Debit (RCUR)</option>
      <option value="OOFF">One-Off Direct Debit (OOFF)</option>
      <option value="FNAL">Final Direct Debit (FNAL)</option>
    </select>

    <button type="button" id="addCreditorData">
      Save Creditor Data
    </button>
  </form>

  <hr/>

  <!-- Section for uploading CSV with debtor data -->
  <h2>Add Debtors/Direct Debit Mandates</h2>
  <p>Option A: Upload a CSV file (debtors) with the following format:</p>
  <pre>First Name;Last Name;Amount;IBAN;Purpose;Mandate;Identification;Issue Date (YYYY-MM-DD format)</pre>
  <input type="file" id="csvFileInput" accept=".csv" />

  <table id="debtorTable" class="hidden">
    <thead>
      <tr>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Amount</th>
        <th>IBAN</th>
        <th>BIC</th>
        <th>Purpose</th>
        <th>Mandate</th>
        <th>Identification</th>
        <th>Issue Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p>Option B: Form for individual debtor records:</p>
  <form id="debtorForm">
    <label for="firstName">First Name</label>
    <input type="text" id="firstName" />

    <label for="lastName">Last Name</label>
    <input type="text" id="lastName" />

    <label for="amount">Amount</label>
    <input type="number" id="amount" step="0.01" />

    <label for="debtorIBAN">IBAN</label>
    <input type="text" id="debtorIBAN" />

    <label for="debtorBIC">BIC (will be automatically determined if possible)</label>
    <input type="text" id="debtorBIC" />

    <label for="usage">Purpose</label>
    <input type="text" id="usage" />

    <label for="mandateId">Mandate Reference</label>
    <input type="text" id="mandateId" />

    <label for="debtorId">Debtor Identification (EndToEndId)</label>
    <input type="text" id="debtorId" />

    <label for="mandateDate">Issue Date</label>
    <input type="date" id="mandateDate" />

    <button type="button" id="addDebtorData">Add This Record</button>
  </form>
  <p id="debtorFormMessage" class="error hidden"></p>

  <hr/>

  <!-- Generate SEPA-XML -->
  <button id="generateXmlButton">Generate SEPA-XML (pain.008.001.08)</button>
  <p id="generationMessage" class="hidden"></p>

  <script>
    /*******************************************************
     * GLOBAL VARIABLES
     *******************************************************/
    let creditorData = {};
    let debtorDataList = [];
    // Here we store BLZ -> BIC
    let blzBicMap = {};

    /*******************************************************
     * ON PAGE LOAD: PARSE BLZ->BIC CSV
     *******************************************************/
    window.addEventListener('DOMContentLoaded', async () => {
      await loadBlzCsv();
    });

    async function loadBlzCsv() {
      try {
        const response = await fetch('./blz-aktuell-csv-data.csv');
        if (!response.ok) {
          console.error('Error loading BLZ file:', response.status, response.statusText);
          return;
        }
        const csvText = await response.text();
        parseBlzCsv(csvText);
      } catch (err) {
        console.error('Error loading BLZ file:', err);
      }
    }

    function parseBlzCsv(csvText) {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
      // First line is usually the header
      let startIndex = 1;

      for (let i = startIndex; i < lines.length; i++) {
        const columns = lines[i].split(';');
        if (columns.length < 8) {
          continue; // Invalid line
        }
        // Bank code in column 0, BIC in column 7
        const blz = columns[0].replace(/"/g, '').trim();
        const bic = columns[7].replace(/"/g, '').trim();

        if (blz && bic) {
          blzBicMap[blz] = bic;
        }
      }
      console.log('BLZ->BIC mapping loaded. Number of entries:', Object.keys(blzBicMap).length);
    }

    function extractBlzFromIban(iban) {
      const cleanIban = iban.replace(/\s+/g, '').toUpperCase();
      if (!cleanIban.startsWith('DE') || cleanIban.length < 22) return null; 
      return cleanIban.substring(4, 12);
    }

    function lookupBicForIban(iban) {
      const blz = extractBlzFromIban(iban);
      if (!blz) return null;
      return blzBicMap[blz] || null;
    }

    // Simple IBAN check
    function checkIBAN(iban) {
      const trimmed = iban.replace(/\s+/g, '').toUpperCase();
      const regex = /^[A-Z0-9]{15,34}$/;
      return regex.test(trimmed);
    }

    /*******************************************************
     * 1) SAVE CREDITOR DATA
     *******************************************************/
    document.getElementById('addCreditorData').addEventListener('click', () => {
      const name = document.getElementById('creditorName').value.trim();
      const iban = document.getElementById('creditorIBAN').value.trim().replace(/\s+/g, '').toUpperCase();
      let bic = document.getElementById('creditorBIC').value.trim();
      const cid = document.getElementById('creditorId').value.trim();
      const paymentInfoId = document.getElementById('paymentInfoId').value.trim();
      const executionDate = document.getElementById('executionDate').value;
      const currency = document.getElementById('currency').value.trim();
      const seqType = document.getElementById('sequenceType').value;

      if (!name || !iban || !cid || !paymentInfoId || !executionDate || !currency) {
        alert('Please fill in all required fields (Name, IBAN, Creditor ID, etc.)!');
        return;
      }

      if (!checkIBAN(iban)) {
        alert('Invalid IBAN!');
        return;
      }

      // If BIC is empty, try lookup (if DE-IBAN)
      if (!bic) {
        const autoBic = lookupBicForIban(iban);
        if (autoBic) {
          bic = autoBic;
          document.getElementById('creditorBIC').value = bic;
        } else {
          alert('No BIC found for IBAN ' + iban);
        }
      }

      // Minimal BIC check
      if (!bic) {
        alert('Please provide a BIC or use lookup!');
        return;
      }

      creditorData = {
        name,
        iban,
        bic,
        cid,
        paymentInfoId,
        executionDate,
        currency,
        seqType
      };
      alert('Creditor data successfully saved.');
    });

    /*******************************************************
     * 2) READ CSV FILE (DEBTORS)
     *******************************************************/
    document.getElementById('csvFileInput').addEventListener('change', handleCSVUpload);
    function handleCSVUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseDebtorCsv(text);
      };
      reader.readAsText(file, 'UTF-8');
    }

    function parseDebtorCsv(csvText) {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
      let startIndex = 0;
      if (
        lines[0].toLowerCase().includes('vorname') &&
        lines[0].toLowerCase().includes('name') &&
        lines[0].toLowerCase().includes('betrag') &&
        lines[0].toLowerCase().includes('iban')
      ) {
        startIndex = 1;
      }

      for (let i = startIndex; i < lines.length; i++) {
        const cols = lines[i].split(';');
        if (cols.length < 8) {
          console.warn('Line has too few columns:', lines[i]);
          continue;
        }
        const [
          firstName,
          lastName,
          amount,
          debtorIban,
          usage,
          mandateId,
          debtorId,
          mandateDate
        ] = cols.map(c => c.replace(/"/g, '').trim());

        if (!checkIBAN(debtorIban)) {
          console.warn('Invalid IBAN in line', i + 1, debtorIban);
          continue;
        }
        let autoBic = lookupBicForIban(debtorIban) || '';

        debtorDataList.push({
          firstName,
          lastName,
          amount: parseFloat(amount.replace(',', '.')),
          debtorIban: debtorIban.toUpperCase(),
          debtorBic: autoBic,
          usage,
          mandateId,
          debtorId,
          mandateDate
        });
      }
      renderDebtorTable();
    }

    function renderDebtorTable() {
      const table = document.getElementById('debtorTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      if (debtorDataList.length === 0) {
        table.classList.add('hidden');
        return;
      }
      table.classList.remove('hidden');
      debtorDataList.forEach((d) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${d.firstName}</td>
          <td>${d.lastName}</td>
          <td>${d.amount}</td>
          <td>${d.debtorIban}</td>
          <td>${d.debtorBic}</td>
          <td>${d.usage}</td>
          <td>${d.mandateId}</td>
          <td>${d.debtorId}</td>
          <td>${d.mandateDate}</td>
        `;
        tbody.appendChild(row);
      });
    }

    /*******************************************************
     * 3) ADD INDIVIDUAL DEBTOR
     *******************************************************/
    document.getElementById('addDebtorData').addEventListener('click', () => {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const amount = document.getElementById('amount').value;
      const debtorIban = document.getElementById('debtorIBAN').value.trim().toUpperCase();
      let debtorBic = document.getElementById('debtorBIC').value.trim();
      const usage = document.getElementById('usage').value.trim();
      const mandateId = document.getElementById('mandateId').value.trim();
      const debtorId = document.getElementById('debtorId').value.trim();
      const mandateDate = document.getElementById('mandateDate').value;

      const messageEl = document.getElementById('debtorFormMessage');
      messageEl.classList.add('hidden');
      messageEl.classList.remove('success', 'error');

      if (!firstName || !lastName || !amount || !debtorIban || !usage || !mandateId || !debtorId || !mandateDate) {
        messageEl.textContent = 'Please fill in all fields!';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('error');
        return;
      }

      if (isNaN(parseFloat(amount))) {
        messageEl.textContent = 'Please enter a valid amount!';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('error');
        return;
      }

      if (!checkIBAN(debtorIban)) {
        messageEl.textContent = 'Invalid IBAN!';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('error');
        return;
      }

      // If BIC is empty -> Lookup
      if (!debtorBic) {
        const autoBic = lookupBicForIban(debtorIban);
        if (autoBic) {
          debtorBic = autoBic;
          document.getElementById('debtorBIC').value = debtorBic;
        }
      }

      debtorDataList.push({
        firstName,
        lastName,
        amount: parseFloat(amount),
        debtorIban,
        debtorBic,
        usage,
        mandateId,
        debtorId,
        mandateDate
      });

      messageEl.textContent = 'Record added.';
      messageEl.classList.remove('hidden');
      messageEl.classList.add('success');

      document.getElementById('debtorForm').reset();
      renderDebtorTable();
    });

    /*******************************************************
     * 4) GENERATE SEPA-XML (pain.008.001.08)
     *******************************************************/
    document.getElementById('generateXmlButton').addEventListener('click', generateSEPA);

    function generateSEPA() {
      const msgEl = document.getElementById('generationMessage');
      msgEl.classList.add('hidden');
      msgEl.innerHTML = '';

      if (!creditorData.name) {
        alert('Please fill in creditor data first!');
        return;
      }
      if (debtorDataList.length === 0) {
        alert('No debtor data available!');
        return;
      }

      // Current date with time (e.g., 2024-12-26T17:53:28Z)
      const now = new Date();
      const isoDateTime = now.toISOString(); // e.g., 2024-12-26T17:53:28.123Z
      // We truncate or convert if necessary to avoid commas with milliseconds
      const creDtTm = isoDateTime.replace(/\.\d{3}Z$/, 'Z'); 

      // MessageId
      const messageId = `SEPA:${creDtTm}`;

      // Number and total
      const numberOfTxs = debtorDataList.length;
      const totalAmount = debtorDataList.reduce((acc, d) => acc + (isNaN(d.amount) ? 0 : d.amount), 0).toFixed(2);

      // pain.008.001.08 XML:
      let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Document 
  xmlns="urn:iso:std:iso:20022:tech:xsd:pain.008.001.08"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xsi:schemaLocation="urn:iso:std:iso:20022:tech:xsd:pain.008.001.08 pain.008.001.08.xsd">
  <CstmrDrctDbtInitn>
    <GrpHdr>
      <MsgId>${messageId}</MsgId>
      <CreDtTm>${creDtTm}</CreDtTm>
      <NbOfTxs>${numberOfTxs}</NbOfTxs>
      <CtrlSum>${totalAmount}</CtrlSum>
      <InitgPty>
        <Nm>${creditorData.name}</Nm>
      </InitgPty>
    </GrpHdr>
    <PmtInf>
      <PmtInfId>${creditorData.paymentInfoId}</PmtInfId>
      <PmtMtd>DD</PmtMtd>
      <BtchBookg>true</BtchBookg>
      <NbOfTxs>${numberOfTxs}</NbOfTxs>
      <CtrlSum>${totalAmount}</CtrlSum>
      <PmtTpInf>
        <SvcLvl>
          <Cd>SEPA</Cd>
        </SvcLvl>
        <LclInstrm>
          <Cd>CORE</Cd>
        </LclInstrm>
        <SeqTp>${creditorData.seqType}</SeqTp>
      </PmtTpInf>
      <ReqdColltnDt>${creditorData.executionDate}</ReqdColltnDt>
      <Cdtr>
        <Nm>${creditorData.name}</Nm>
      </Cdtr>
      <CdtrAcct>
        <Id>
          <IBAN>${creditorData.iban}</IBAN>
        </Id>
      </CdtrAcct>
      <CdtrAgt>
        <FinInstnId>
          <BICFI>${creditorData.bic}</BICFI>
        </FinInstnId>
      </CdtrAgt>
      <ChrgBr>SLEV</ChrgBr>
      <CdtrSchmeId>
        <Id>
          <PrvtId>
            <Othr>
              <Id>${creditorData.cid}</Id>
              <SchmeNm>
                <Prtry>SEPA</Prtry>
              </SchmeNm>
            </Othr>
          </PrvtId>
        </Id>
      </CdtrSchmeId>`;

      // Entries for each debtor
      debtorDataList.forEach((debtor) => {
        const amountFormatted = debtor.amount.toFixed(2);
        xml += `
      <DrctDbtTxInf>
        <PmtId>
          <EndToEndId>${debtor.debtorId}</EndToEndId>
        </PmtId>
        <InstdAmt Ccy="${creditorData.currency}">${amountFormatted}</InstdAmt>
        <DrctDbtTx>
          <MndtRltdInf>
            <MndtId>${debtor.mandateId}</MndtId>
            <DtOfSgntr>${debtor.mandateDate}</DtOfSgntr>
            <AmdmntInd>false</AmdmntInd>
          </MndtRltdInf>
        </DrctDbtTx>
        <DbtrAgt>
          <FinInstnId>`;

        if (debtor.debtorBic) {
          xml += `
            <BICFI>${debtor.debtorBic}</BICFI>`;
        } else {
          // e.g., "NOTPROVIDED":
          xml += `
            <Othr>
              <Id>NOTPROVIDED</Id>
            </Othr>`;
        }

        xml += `
          </FinInstnId>
        </DbtrAgt>
        <Dbtr>
          <Nm>${debtor.firstName} ${debtor.lastName}</Nm>
        </Dbtr>
        <DbtrAcct>
          <Id>
            <IBAN>${debtor.debtorIban}</IBAN>
          </Id>
        </DbtrAcct>
        <RmtInf>
          <Ustrd>${debtor.usage}</Ustrd>
        </RmtInf>
      </DrctDbtTxInf>`;
      });

      xml += `
    </PmtInf>
  </CstmrDrctDbtInitn>
</Document>`;

      // Offer download
      const blob = new Blob([xml], { type: 'application/xml' });
      const fileName = `SEPA_${Date.now()}.xml`;

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      link.textContent = `Click here to download SEPA-XML (${fileName}).`;

      msgEl.classList.remove('hidden');
      msgEl.appendChild(link);
    }
  </script>
</body>
</html>
