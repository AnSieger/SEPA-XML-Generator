<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SEPA-XML Generator (with BLZ -> BIC Lookup, pain.008.001.08)</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 3rem;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .card h2 {
      color: #4a5568;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0.5rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    input, select {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: #f7fafc;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .primary-button {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
      padding: 1rem 3rem;
      font-size: 1.1rem;
      margin: 2rem 0;
    }
    
    .primary-button:hover {
      box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-display {
      display: block;
      padding: 0.75rem 1rem;
      background: #f7fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      text-align: center;
      color: #718096;
      transition: all 0.3s ease;
    }
    
    .file-input-wrapper:hover .file-input-display {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    .error {
      color: #e53e3e;
      font-size: 0.9rem;
      background: #fed7d7;
      padding: 0.5rem;
      border-radius: 6px;
      border-left: 4px solid #e53e3e;
    }
    
    .success {
      color: #38a169;
      font-size: 0.9rem;
      background: #c6f6d5;
      padding: 0.5rem;
      border-radius: 6px;
      border-left: 4px solid #38a169;
    }
    
    .hidden {
      display: none;
    }
    
    .csv-format {
      background: #2d3748;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
    }
    
    td {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    tr:hover {
      background: #f7fafc;
    }
    
    .options-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-top: 2rem;
    }
    
    .option-card {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.5rem;
    }
    
    .option-card h3 {
      color: #4a5568;
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    
    .divider {
      height: 2px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 3rem 0;
      border-radius: 1px;
      opacity: 0.3;
    }
    
    .coffee-button {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
      border: none;
      padding: 0.8rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      margin: 1rem 0;
    }
    
    .coffee-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
      text-decoration: none;
      color: white;
    }
    
    .coffee-button:active {
      transform: translateY(0);
    }
    
    .support-section {
      text-align: center;
      margin: 2rem 0;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .support-section p {
      color: white;
      margin-bottom: 1rem;
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .footer {
      text-align: center;
      margin-top: 3rem;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .footer h3 {
      color: white;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    
    .footer p {
      color: white;
      opacity: 0.8;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    
    .support-options {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    
    .github-link {
      background: linear-gradient(135deg, #24292e 0%, #1e2328 100%);
      color: white;
      text-decoration: none;
      padding: 0.6rem 1.5rem;
      border-radius: 20px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 4px 15px rgba(36, 41, 46, 0.3);
    }
    
    .github-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(36, 41, 46, 0.4);
      text-decoration: none;
      color: white;
    }
    
    .footer-note {
      font-size: 0.9rem;
      opacity: 0.7;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding-top: 1rem;
      margin-top: 1rem;
    }
    
    .disclaimer {
      background: rgba(255, 193, 7, 0.1);
      border: 2px solid rgba(255, 193, 7, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 2rem 0;
      color: white;
    }
    
    .disclaimer h3 {
      color: #ffc107;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .disclaimer p {
      line-height: 1.6;
      margin-bottom: 0.8rem;
      opacity: 0.9;
    }
    
    .disclaimer ul {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }
    
    .disclaimer li {
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }
    
    .disclaimer .warning-text {
      font-weight: 600;
      color: #ffc107;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .options-section {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      .card {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>SEPA-XML Generator</h1>
      <p>
        This tool reads a .csv file and generates a SEPA XML with BLZ‚ÜíBIC lookup for German IBANs.
        All data is processed locally in your browser for maximum security.
      </p>
      
      <div class="support-section">
        <p>‚òï Enjoy this free tool? Support its development!</p>
        <a href="https://www.buymeacoffee.com/ansieger" target="_blank" class="coffee-button">
          ‚òï Buy me a coffee
        </a>
      </div>
    </div>
    
    <div class="card">
      <h2>üíº Creditor Data</h2>
  <form id="creditorForm">
    <div class="form-grid">
      <div class="form-group">
        <label for="creditorName">Creditor Name</label>
        <input type="text" id="creditorName" required />
      </div>

      <div class="form-group">
        <label for="creditorIBAN">Creditor IBAN</label>
        <input type="text" id="creditorIBAN" required />
      </div>

      <div class="form-group">
        <label for="creditorBIC">Creditor BIC</label>
        <input type="text" id="creditorBIC" required placeholder="Will be auto-detected for German IBANs" />
      </div>

      <div class="form-group">
        <label for="creditorId">Creditor Identifier</label>
        <input type="text" id="creditorId" required />
      </div>

      <div class="form-group">
        <label for="paymentInfoId">Payment Info ID</label>
        <input type="text" id="paymentInfoId" required placeholder="e.g., RE-2023-001" />
      </div>

      <div class="form-group">
        <label for="executionDate">Execution Date</label>
        <input type="date" id="executionDate" required />
      </div>

      <div class="form-group">
        <label for="currency">Currency</label>
        <input type="text" id="currency" value="EUR" required />
      </div>

      <div class="form-group">
        <label for="sequenceType">Sequence Type</label>
        <select id="sequenceType">
          <option value="FRST">First Direct Debit (FRST)</option>
          <option value="RCUR" selected>Recurring Direct Debit (RCUR)</option>
          <option value="OOFF">One-Off Direct Debit (OOFF)</option>
          <option value="FNAL">Final Direct Debit (FNAL)</option>
        </select>
      </div>
    </div>

    <button type="button" id="addCreditorData">
      üíæ Save Creditor Data
    </button>
  </form>
    </div>

    <div class="divider"></div>

    <!-- Section for uploading CSV with debtor data -->
    <div class="card">
      <h2>üìã Add Debtors/Direct Debit Mandates</h2>
      
      <div class="options-section">
        <div class="option-card">
          <h3>üìÅ Option A: Upload CSV File</h3>
          <p>Upload a CSV file with debtor data using this format:</p>
          <div class="csv-format">First Name;Last Name;Amount;IBAN;Purpose;Mandate;Identification;Issue Date (YYYY-MM-DD)</div>
          
          <div class="file-input-wrapper">
            <input type="file" id="csvFileInput" accept=".csv" />
            <span class="file-input-display">üìé Click to select CSV file or drag & drop</span>
          </div>
        </div>

        <div class="option-card">
          <h3>‚úèÔ∏è Option B: Manual Entry</h3>
          <p>Add individual debtor records using the form below.</p>
        </div>
      </div>

      <table id="debtorTable" class="hidden">
        <thead>
          <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Amount</th>
            <th>IBAN</th>
            <th>BIC</th>
            <th>Purpose</th>
            <th>Mandate</th>
            <th>Identification</th>
            <th>Issue Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2>üë§ Individual Debtor Entry</h2>
  <form id="debtorForm">
    <div class="form-grid">
      <div class="form-group">
        <label for="firstName">First Name</label>
        <input type="text" id="firstName" />
      </div>

      <div class="form-group">
        <label for="lastName">Last Name</label>
        <input type="text" id="lastName" />
      </div>

      <div class="form-group">
        <label for="amount">Amount (‚Ç¨)</label>
        <input type="number" id="amount" step="0.01" />
      </div>

      <div class="form-group">
        <label for="debtorIBAN">IBAN</label>
        <input type="text" id="debtorIBAN" />
      </div>

      <div class="form-group">
        <label for="debtorBIC">BIC</label>
        <input type="text" id="debtorBIC" placeholder="Auto-detected for German IBANs" />
      </div>

      <div class="form-group">
        <label for="usage">Purpose</label>
        <input type="text" id="usage" />
      </div>

      <div class="form-group">
        <label for="mandateId">Mandate Reference</label>
        <input type="text" id="mandateId" />
      </div>

      <div class="form-group">
        <label for="debtorId">Debtor ID (EndToEndId)</label>
        <input type="text" id="debtorId" />
      </div>

      <div class="form-group">
        <label for="mandateDate">Issue Date</label>
        <input type="date" id="mandateDate" />
      </div>
    </div>

    <button type="button" id="addDebtorData">‚ûï Add This Record</button>
  </form>
  <p id="debtorFormMessage" class="error hidden"></p>
    </div>

    <div class="divider"></div>

    <!-- Generate SEPA-XML -->
    <div class="card" style="text-align: center;">
      <h2>üöÄ Generate SEPA XML</h2>
      <button id="generateXmlButton" class="primary-button">üìÑ Generate SEPA-XML (pain.008.001.08)</button>
      <p id="generationMessage" class="hidden"></p>
    </div>
    
    <!-- Support Footer -->
    <div class="footer">
      <h3>üíù Support This Project</h3>
      <p>
        This SEPA-XML Generator is completely free and open-source. If you find it useful, 
        consider supporting its development and maintenance. Your support helps keep this tool 
        free and continuously improved!
      </p>
      
      <div class="support-options">
        <a href="https://www.buymeacoffee.com/ansieger" target="_blank" class="coffee-button">
          ‚òï Buy me a coffee
        </a>
        <a href="https://github.com/AnSieger/SEPA-XML-Generator" target="_blank" class="github-link">
          ‚≠ê Star on GitHub
        </a>
      </div>
      
      <div class="footer-note">
        <p>Made with ‚ù§Ô∏è by AnSieger | All data processed locally | No tracking, no cookies</p>
        <p style="margin-top: 1rem; font-weight: 600; color: #ffc107;">
          ‚ö†Ô∏è No warranty provided - Use at your own risk - Always verify generated files before banking submission
        </p>
      </div>
    </div>
  </div>

  <script>
    /*******************************************************
     * GLOBAL VARIABLES
     *******************************************************/
    let creditorData = {};
    let debtorDataList = [];
    // Here we store BLZ -> BIC
    let blzBicMap = {};

    /*******************************************************
     * ON PAGE LOAD: PARSE BLZ->BIC CSV
     *******************************************************/
    window.addEventListener('DOMContentLoaded', async () => {
      await loadBlzCsv();
    });

    async function loadBlzCsv() {
      try {
        const response = await fetch('./blz-aktuell-csv-data.csv');
        if (!response.ok) {
          console.error('Error loading BLZ file:', response.status, response.statusText);
          return;
        }
        const csvText = await response.text();
        parseBlzCsv(csvText);
      } catch (err) {
        console.error('Error loading BLZ file:', err);
      }
    }

    function parseBlzCsv(csvText) {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
      // First line is usually the header
      let startIndex = 1;

      for (let i = startIndex; i < lines.length; i++) {
        const columns = lines[i].split(';');
        if (columns.length < 8) {
          continue; // Invalid line
        }
        // Bank code in column 0, BIC in column 7
        const blz = columns[0].replace(/"/g, '').trim();
        const bic = columns[7].replace(/"/g, '').trim();

        if (blz && bic) {
          blzBicMap[blz] = bic;
        }
      }
      console.log('BLZ->BIC mapping loaded. Number of entries:', Object.keys(blzBicMap).length);
    }

    function extractBlzFromIban(iban) {
      const cleanIban = iban.replace(/\s+/g, '').toUpperCase();
      if (!cleanIban.startsWith('DE') || cleanIban.length < 22) return null; 
      return cleanIban.substring(4, 12);
    }

    function lookupBicForIban(iban) {
      const blz = extractBlzFromIban(iban);
      if (!blz) return null;
      return blzBicMap[blz] || null;
    }

    // Simple IBAN check
    function checkIBAN(iban) {
      const trimmed = iban.replace(/\s+/g, '').toUpperCase();
      const regex = /^[A-Z0-9]{15,34}$/;
      return regex.test(trimmed);
    }

    /*******************************************************
     * 1) SAVE CREDITOR DATA
     *******************************************************/
    document.getElementById('addCreditorData').addEventListener('click', () => {
      const name = document.getElementById('creditorName').value.trim();
      const iban = document.getElementById('creditorIBAN').value.trim().replace(/\s+/g, '').toUpperCase();
      let bic = document.getElementById('creditorBIC').value.trim();
      const cid = document.getElementById('creditorId').value.trim();
      const paymentInfoId = document.getElementById('paymentInfoId').value.trim();
      const executionDate = document.getElementById('executionDate').value;
      const currency = document.getElementById('currency').value.trim();
      const seqType = document.getElementById('sequenceType').value;

      if (!name || !iban || !cid || !paymentInfoId || !executionDate || !currency) {
        alert('Please fill in all required fields (Name, IBAN, Creditor ID, etc.)!');
        return;
      }

      if (!checkIBAN(iban)) {
        alert('Invalid IBAN!');
        return;
      }

      // If BIC is empty, try lookup (if DE-IBAN)
      if (!bic) {
        const autoBic = lookupBicForIban(iban);
        if (autoBic) {
          bic = autoBic;
          document.getElementById('creditorBIC').value = bic;
        } else {
          alert('No BIC found for IBAN ' + iban);
        }
      }

      // Minimal BIC check
      if (!bic) {
        alert('Please provide a BIC or use lookup!');
        return;
      }

      creditorData = {
        name,
        iban,
        bic,
        cid,
        paymentInfoId,
        executionDate,
        currency,
        seqType
      };
      alert('Creditor data successfully saved.');
    });

    /*******************************************************
     * 2) READ CSV FILE (DEBTORS)
     *******************************************************/
    document.getElementById('csvFileInput').addEventListener('change', handleCSVUpload);
    
    // Update file input display
    document.getElementById('csvFileInput').addEventListener('change', function(e) {
      const fileDisplay = document.querySelector('.file-input-display');
      if (e.target.files.length > 0) {
        fileDisplay.textContent = `üìÅ Selected: ${e.target.files[0].name}`;
        fileDisplay.style.borderColor = '#48bb78';
        fileDisplay.style.background = '#c6f6d5';
        fileDisplay.style.color = '#38a169';
      } else {
        fileDisplay.textContent = 'üìé Click to select CSV file or drag & drop';
        fileDisplay.style.borderColor = '#cbd5e0';
        fileDisplay.style.background = '#f7fafc';
        fileDisplay.style.color = '#718096';
      }
    });
    
    function handleCSVUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseDebtorCsv(text);
      };
      reader.readAsText(file, 'UTF-8');
    }

    function parseDebtorCsv(csvText) {
      const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
      let startIndex = 0;
      if (
        lines[0].toLowerCase().includes('vorname') &&
        lines[0].toLowerCase().includes('name') &&
        lines[0].toLowerCase().includes('betrag') &&
        lines[0].toLowerCase().includes('iban')
      ) {
        startIndex = 1;
      }

      for (let i = startIndex; i < lines.length; i++) {
        const cols = lines[i].split(';');
        if (cols.length < 8) {
          console.warn('Line has too few columns:', lines[i]);
          continue;
        }
        const [
          firstName,
          lastName,
          amount,
          debtorIban,
          usage,
          mandateId,
          debtorId,
          mandateDate
        ] = cols.map(c => c.replace(/"/g, '').trim());

        if (!checkIBAN(debtorIban)) {
          console.warn('Invalid IBAN in line', i + 1, debtorIban);
          continue;
        }
        let autoBic = lookupBicForIban(debtorIban) || '';

        debtorDataList.push({
          firstName,
          lastName,
          amount: parseFloat(amount.replace(',', '.')),
          debtorIban: debtorIban.toUpperCase(),
          debtorBic: autoBic,
          usage,
          mandateId,
          debtorId,
          mandateDate
        });
      }
      renderDebtorTable();
    }

    function renderDebtorTable() {
      const table = document.getElementById('debtorTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      if (debtorDataList.length === 0) {
        table.classList.add('hidden');
        return;
      }
      table.classList.remove('hidden');
      debtorDataList.forEach((d) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${d.firstName}</td>
          <td>${d.lastName}</td>
          <td>${d.amount}</td>
          <td>${d.debtorIban}</td>
          <td>${d.debtorBic}</td>
          <td>${d.usage}</td>
          <td>${d.mandateId}</td>
          <td>${d.debtorId}</td>
          <td>${d.mandateDate}</td>
        `;
        tbody.appendChild(row);
      });
    }

    /*******************************************************
     * 3) ADD INDIVIDUAL DEBTOR
     *******************************************************/
    document.getElementById('addDebtorData').addEventListener('click', () => {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const amount = document.getElementById('amount').value;
      const debtorIban = document.getElementById('debtorIBAN').value.trim().toUpperCase();
      let debtorBic = document.getElementById('debtorBIC').value.trim();
      const usage = document.getElementById('usage').value.trim();
      const mandateId = document.getElementById('mandateId').value.trim();
      const debtorId = document.getElementById('debtorId').value.trim();
      const mandateDate = document.getElementById('mandateDate').value;

      const messageEl = document.getElementById('debtorFormMessage');
      messageEl.classList.add('hidden');
      messageEl.classList.remove('success', 'error');

      if (!firstName || !lastName || !amount || !debtorIban || !usage || !mandateId || !debtorId || !mandateDate) {
        messageEl.textContent = 'Please fill in all fields!';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('error');
        return;
      }

      if (isNaN(parseFloat(amount))) {
        messageEl.textContent = 'Please enter a valid amount!';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('error');
        return;
      }

      if (!checkIBAN(debtorIban)) {
        messageEl.textContent = 'Invalid IBAN!';
        messageEl.classList.remove('hidden');
        messageEl.classList.add('error');
        return;
      }

      // If BIC is empty -> Lookup
      if (!debtorBic) {
        const autoBic = lookupBicForIban(debtorIban);
        if (autoBic) {
          debtorBic = autoBic;
          document.getElementById('debtorBIC').value = debtorBic;
        }
      }

      debtorDataList.push({
        firstName,
        lastName,
        amount: parseFloat(amount),
        debtorIban,
        debtorBic,
        usage,
        mandateId,
        debtorId,
        mandateDate
      });

      messageEl.textContent = 'Record added.';
      messageEl.classList.remove('hidden');
      messageEl.classList.add('success');

      document.getElementById('debtorForm').reset();
      renderDebtorTable();
    });

    /*******************************************************
     * 4) GENERATE SEPA-XML (pain.008.001.08)
     *******************************************************/
    document.getElementById('generateXmlButton').addEventListener('click', generateSEPA);

    function generateSEPA() {
      const msgEl = document.getElementById('generationMessage');
      msgEl.classList.add('hidden');
      msgEl.innerHTML = '';

      if (!creditorData.name) {
        alert('Please fill in creditor data first!');
        return;
      }
      if (debtorDataList.length === 0) {
        alert('No debtor data available!');
        return;
      }

      // Current date with time (e.g., 2024-12-26T17:53:28Z)
      const now = new Date();
      const isoDateTime = now.toISOString(); // e.g., 2024-12-26T17:53:28.123Z
      // We truncate or convert if necessary to avoid commas with milliseconds
      const creDtTm = isoDateTime.replace(/\.\d{3}Z$/, 'Z'); 

      // MessageId
      const messageId = `SEPA:${creDtTm}`;

      // Number and total
      const numberOfTxs = debtorDataList.length;
      const totalAmount = debtorDataList.reduce((acc, d) => acc + (isNaN(d.amount) ? 0 : d.amount), 0).toFixed(2);

      // pain.008.001.08 XML:
      let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Document 
  xmlns="urn:iso:std:iso:20022:tech:xsd:pain.008.001.08"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xsi:schemaLocation="urn:iso:std:iso:20022:tech:xsd:pain.008.001.08 pain.008.001.08.xsd">
  <CstmrDrctDbtInitn>
    <GrpHdr>
      <MsgId>${messageId}</MsgId>
      <CreDtTm>${creDtTm}</CreDtTm>
      <NbOfTxs>${numberOfTxs}</NbOfTxs>
      <CtrlSum>${totalAmount}</CtrlSum>
      <InitgPty>
        <Nm>${creditorData.name}</Nm>
      </InitgPty>
    </GrpHdr>
    <PmtInf>
      <PmtInfId>${creditorData.paymentInfoId}</PmtInfId>
      <PmtMtd>DD</PmtMtd>
      <BtchBookg>true</BtchBookg>
      <NbOfTxs>${numberOfTxs}</NbOfTxs>
      <CtrlSum>${totalAmount}</CtrlSum>
      <PmtTpInf>
        <SvcLvl>
          <Cd>SEPA</Cd>
        </SvcLvl>
        <LclInstrm>
          <Cd>CORE</Cd>
        </LclInstrm>
        <SeqTp>${creditorData.seqType}</SeqTp>
      </PmtTpInf>
      <ReqdColltnDt>${creditorData.executionDate}</ReqdColltnDt>
      <Cdtr>
        <Nm>${creditorData.name}</Nm>
      </Cdtr>
      <CdtrAcct>
        <Id>
          <IBAN>${creditorData.iban}</IBAN>
        </Id>
      </CdtrAcct>
      <CdtrAgt>
        <FinInstnId>
          <BICFI>${creditorData.bic}</BICFI>
        </FinInstnId>
      </CdtrAgt>
      <ChrgBr>SLEV</ChrgBr>
      <CdtrSchmeId>
        <Id>
          <PrvtId>
            <Othr>
              <Id>${creditorData.cid}</Id>
              <SchmeNm>
                <Prtry>SEPA</Prtry>
              </SchmeNm>
            </Othr>
          </PrvtId>
        </Id>
      </CdtrSchmeId>`;

      // Entries for each debtor
      debtorDataList.forEach((debtor) => {
        const amountFormatted = debtor.amount.toFixed(2);
        xml += `
      <DrctDbtTxInf>
        <PmtId>
          <EndToEndId>${debtor.debtorId}</EndToEndId>
        </PmtId>
        <InstdAmt Ccy="${creditorData.currency}">${amountFormatted}</InstdAmt>
        <DrctDbtTx>
          <MndtRltdInf>
            <MndtId>${debtor.mandateId}</MndtId>
            <DtOfSgntr>${debtor.mandateDate}</DtOfSgntr>
            <AmdmntInd>false</AmdmntInd>
          </MndtRltdInf>
        </DrctDbtTx>
        <DbtrAgt>
          <FinInstnId>`;

        if (debtor.debtorBic) {
          xml += `
            <BICFI>${debtor.debtorBic}</BICFI>`;
        } else {
          // e.g., "NOTPROVIDED":
          xml += `
            <Othr>
              <Id>NOTPROVIDED</Id>
            </Othr>`;
        }

        xml += `
          </FinInstnId>
        </DbtrAgt>
        <Dbtr>
          <Nm>${debtor.firstName} ${debtor.lastName}</Nm>
        </Dbtr>
        <DbtrAcct>
          <Id>
            <IBAN>${debtor.debtorIban}</IBAN>
          </Id>
        </DbtrAcct>
        <RmtInf>
          <Ustrd>${debtor.usage}</Ustrd>
        </RmtInf>
      </DrctDbtTxInf>`;
      });

      xml += `
    </PmtInf>
  </CstmrDrctDbtInitn>
</Document>`;

      // Offer download
      const blob = new Blob([xml], { type: 'application/xml' });
      const fileName = `SEPA_${Date.now()}.xml`;

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = fileName;
      link.textContent = `Click here to download SEPA-XML (${fileName}).`;

      msgEl.classList.remove('hidden');
      msgEl.appendChild(link);
    }
  </script>
</body>
</html>
